<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        video, canvas { display: block; margin: 20px auto; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        .vote-options { display: none; }
    </style>
</head>
<body data-admin-vote="{{ admin_vote|tojson }}">
    <h1 id="page-title">Face Recognition for Voting</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <button id="recognize">Recognize Face</button>
    <p id="status"></p>
    <div id="vote-options" class="vote-options">
        <h2>Welcome, <span id="voter-name"></span></h2>
        <p id="vote-instructions">Loading candidates...</p>
        <div id="candidates-buttons"></div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const recognizeBtn = document.getElementById('recognize');
        const status = document.getElementById('status');
        const voteOptions = document.getElementById('vote-options');
        const voterName = document.getElementById('voter-name');
        const pageTitle = document.getElementById('page-title');

        let recognizedName = null;
        let intervalId = null;

        // Check if this is admin voting
        const adminVote = document.body.getAttribute('data-admin-vote') === 'true';

        if (adminVote) {
            pageTitle.textContent = 'Admin Voting';
            // Skip face recognition for admin voting
            loadCandidatesForVoting();
            voteOptions.style.display = 'block';
            recognizeBtn.style.display = 'none';
            video.style.display = 'none';
            status.textContent = 'Admin voting mode - select candidate to vote on behalf of voter';
        } else {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    // Start continuous recognition
                    intervalId = setInterval(recognizeFace, 1000);
                })
                .catch(err => {
                    console.error('Error accessing webcam:', err);
                });
        }

        function recognizeFace() {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, 640, 480);
            const imageData = canvas.toDataURL('image/png');

            fetch('/recognize_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.recognized) {
                    if (data.already_voted) {
                        status.textContent = `${data.name}, you have already voted!`;
                        alert(`${data.name}, you have already voted for ${data.vote_details ? data.vote_details.vote : 'unknown'} on ${data.vote_details ? data.vote_details.date : 'unknown'} at ${data.vote_details ? data.vote_details.time : 'unknown'}!`);
                        speak("YOU HAVE ALREADY VOTED");
                        // Show vote details popup
                        showAlreadyVotedPopup(data.name, data.vote_details);
                        clearInterval(intervalId);
                    } else {
                        recognizedName = data.name;
                        voterName.textContent = data.name;
                        loadCandidatesForVoting();
                        voteOptions.style.display = 'block';
                        recognizeBtn.style.display = 'none';
                        status.textContent = '';
                        clearInterval(intervalId);
                        // Listen for key presses
                        document.addEventListener('keydown', handleKeyPress);
                    }
                } else {
                    status.textContent = 'Face not recognized. Keep your face in front of the camera.';
                }
            });
        }

        function loadCandidatesForVoting() {
            fetch('/get_candidates')
            .then(response => response.json())
            .then(data => {
                const instructions = document.getElementById('vote-instructions');
                const buttonsDiv = document.getElementById('candidates-buttons');
                buttonsDiv.innerHTML = '';

                if (data.candidates && data.candidates.length > 0) {
                    instructions.textContent = 'Select your candidate by clicking the button or pressing the corresponding number key:';
                    data.candidates.forEach((candidate, index) => {
                        const button = document.createElement('button');
                        button.className = 'vote-btn';
                        button.setAttribute('data-vote', candidate.name);
                        button.setAttribute('data-key', (index + 1).toString());
                        button.style.display = 'block';
                        button.style.width = '100%';
                        button.style.margin = '10px 0';
                        button.style.padding = '15px';
                        button.style.fontSize = '18px';
                        button.style.background = '#007bff';
                        button.style.color = 'white';
                        button.style.border = 'none';
                        button.style.borderRadius = '10px';
                        button.style.cursor = 'pointer';

                        let iconHtml = '';
                        if (candidate.icon) {
                            iconHtml = `<img src="/${candidate.icon}" alt="${candidate.group} icon" style="width: 30px; height: 30px; margin-right: 10px; vertical-align: middle;">`;
                        }

                        button.innerHTML = `${index + 1}. ${iconHtml}<strong>${candidate.name}</strong> (${candidate.position}) - ${candidate.group}`;
                        button.onclick = () => submitVote(candidate.name);
                        buttonsDiv.appendChild(button);
                    });
                } else {
                    instructions.textContent = 'No candidates available. Please contact administrator.';
                }
            })
            .catch(err => {
                console.error('Error loading candidates:', err);
                document.getElementById('vote-instructions').textContent = 'Error loading candidates.';
            });
        }

        function handleKeyPress(event) {
            const buttons = document.querySelectorAll('.vote-btn');
            let vote = null;

            buttons.forEach(button => {
                if (button.getAttribute('data-key') === event.key) {
                    vote = button.getAttribute('data-vote');
                }
            });

            if (vote && recognizedName) {
                submitVote(vote);
            }
        }

        function submitVote(vote) {
            fetch('/submit_vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: recognizedName, vote: vote })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'Vote recorded successfully! Thank you.';
                    voteOptions.style.display = 'none';
                    speak("YOUR VOTE HAS BEEN RECORDED. THANK YOU FOR PARTICIPATING IN THE ELECTIONS");
                    document.removeEventListener('keydown', handleKeyPress);
                    // Show popup with vote details
                    setTimeout(() => {
                        showVotePopup(recognizedName, vote);
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('Error submitting vote:', err);
                status.textContent = 'Error recording vote. Please try again.';
            });
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utterance);
            }
        }

        function showVotePopup(name, vote) {
            fetch('/get_vote_details')
            .then(response => response.json())
            .then(data => {
                // Create popup overlay
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.zIndex = '1000';

                // Create popup content
                const popup = document.createElement('div');
                popup.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                popup.style.padding = '40px';
                popup.style.borderRadius = '20px';
                popup.style.boxShadow = '0 20px 40px rgba(0,0,0,0.3)';
                popup.style.maxWidth = '500px';
                popup.style.width = '90%';
                popup.style.textAlign = 'center';
                popup.style.color = 'white';
                popup.style.animation = 'popupAppear 0.5s ease-out';

                popup.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                    <h2 style="margin-bottom: 30px; font-size: 28px;">Vote Recorded Successfully!</h2>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <div style="margin-bottom: 15px;"><strong>Name:</strong> ${data.name}</div>
                        <div style="margin-bottom: 15px;"><strong>Voter ID:</strong> ${data.voterid}</div>
                        <div style="margin-bottom: 15px;"><strong>Vote Casted:</strong> ${data.vote}</div>
                        <div style="margin-bottom: 15px;"><strong>Date:</strong> ${data.date}</div>
                        <div style="margin-bottom: 15px;"><strong>Aadhar Card Number:</strong> ${data.aadhar}</div>
                    </div>
                    <p style="font-style: italic;">Thank you for participating in the elections!</p>
                `;

                overlay.appendChild(popup);
                document.body.appendChild(overlay);

                // Auto close after 5 seconds
                setTimeout(() => {
                    overlay.style.animation = 'popupDisappear 0.5s ease-in';
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                        // Return to homepage after popup
                        window.location.href = '/';
                    }, 500);
                }, 5000);

                // Add CSS animations
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes popupAppear {
                        from { transform: scale(0.7); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    @keyframes popupDisappear {
                        from { transform: scale(1); opacity: 1; }
                        to { transform: scale(0.7); opacity: 0; }
                `;
                document.head.appendChild(style);
            });
        }

        function showAlreadyVotedPopup(name, voteDetails) {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';

            // Create popup content
            const popup = document.createElement('div');
            popup.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            popup.style.padding = '40px';
            popup.style.borderRadius = '20px';
            popup.style.boxShadow = '0 20px 40px rgba(0,0,0,0.3)';
            popup.style.maxWidth = '500px';
            popup.style.width = '90%';
            popup.style.textAlign = 'center';
            popup.style.color = 'white';
            popup.style.animation = 'popupAppear 0.5s ease-out';

            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                <h2 style="margin-bottom: 30px; font-size: 28px;">Already Voted!</h2>
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <div style="margin-bottom: 15px;"><strong>Name:</strong> ${name}</div>
                    <div style="margin-bottom: 15px;"><strong>Vote Casted:</strong> ${voteDetails.vote}</div>
                    <div style="margin-bottom: 15px;"><strong>Date:</strong> ${voteDetails.date}</div>
                    <div style="margin-bottom: 15px;"><strong>Time:</strong> ${voteDetails.time}</div>
                </div>
                <p style="font-style: italic;">You have already participated in the elections.</p>
            `;

            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Speak the details
            speak(`You have already voted for ${voteDetails.vote} on ${voteDetails.date} at ${voteDetails.time}`);

            // Auto close after 8 seconds
            setTimeout(() => {
                overlay.style.animation = 'popupDisappear 0.5s ease-in';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    // Return to homepage after popup
                    window.location.href = '/';
                }, 500);
            }, 8000);

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popupAppear {
                    from { transform: scale(0.7); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }
                @keyframes popupDisappear {
                    from { transform: scale(1); opacity: 1; }
                    to { transform: scale(0.7); opacity: 0; }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
